# Test that the bootc kickstart command can install in an encrypted scenario.

# Use the default settings.
%ksappend common/common_no_storage_and_payload.ks

# Default storage configuration with LUKS
%ksappend storage/ostreecontainer_autopart_encrypted.ks

# Validate on the first boot.
%ksappend validation/success_on_first_boot.ks

# Setup the bootc image source.
# Substitute something in for KSTEST_OSTREECONTAINER_URL or this will all come crashing down.
bootc --source-imgref=registry:@KSTEST_OSTREECONTAINER_URL@ --stateroot=test-stateroot

# Reboot the installed system.
reboot

%ksappend storage/luks_auto_unlock_post.ks

%post
# Checks after boot
cat >> /var/lib/extensions/kickstart-tests/usr/libexec/kickstart-test.sh << 'EOF'

# propagate any errors from %post validations;
# we only check that the system booted, so the following generic
# snippet is left in place just for potential future purposes
if [ -e /root/RESULT ]; then
    cat /root/RESULT
fi

EOF
%end

